{% extends "base.html" %}
{% block content %}
<div class="wow-card p-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <h2 class="wow-section-title mb-1">Quest Log</h2>
      <div class="text-light">
        <strong>{{ character.char_name }}</strong> (Level {{ character.level }})
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('character_detail', character_id=character.character_id) }}">Back</a>
    </div>
  </div>

  <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
    <div class="btn-group" role="group">
      <a class="btn btn-sm {% if view=='all' %}btn-warning{% else %}btn-outline-warning{% endif %}"
         href="{{ url_for('character_quests', character_id=character.character_id, view='all', type=qtype) }}">All</a>
      <a class="btn btn-sm {% if view=='in_progress' %}btn-warning{% else %}btn-outline-warning{% endif %}"
         href="{{ url_for('character_quests', character_id=character.character_id, view='in_progress', type=qtype) }}">In Progress</a>
      <a class="btn btn-sm {% if view=='completed' %}btn-warning{% else %}btn-outline-warning{% endif %}"
         href="{{ url_for('character_quests', character_id=character.character_id, view='completed', type=qtype) }}">Completed</a>
      <a class="btn btn-sm {% if view=='not_started' %}btn-warning{% else %}btn-outline-warning{% endif %}"
         href="{{ url_for('character_quests', character_id=character.character_id, view='not_started', type=qtype) }}">Not Started</a>
    </div>

    <form method="get" class="ms-auto d-flex gap-2 align-items-center">
      <input type="hidden" name="view" value="{{ view }}">
      <select class="form-select form-select-sm" name="type" onchange="this.form.submit()">
        <option value="">All Types</option>
        {% for t in types %}
          <option value="{{ t.type }}" {% if qtype==t.type %}selected{% endif %}>{{ t.type }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  {% if is_owner %}
  <form method="post" class="mt-3">
  {% endif %}

    <div class="table-responsive mt-3">
      <table class="table table-dark table-striped table-hover align-middle mb-0">
        <thead>
          <tr>
            <th style="min-width:260px;">Quest</th>
            <th style="width:90px;">Lvl</th>
            <th style="width:140px;">Type</th>
            <th>Rewards</th>
            <th style="width:170px;">Status</th>
          </tr>
        </thead>
        <tbody>
        {% for q in quests %}
          {% set st = computed_status(q.quest_id) %}
          <tr>
            <td class="text-light">{{ q.name }}</td>
            <td class="text-light">{{ q.level_req if q.level_req is not none else '' }}</td>
            <td class="text-light">{{ q.type }}</td>
            <td class="text-light">
              {% if q.reward_item_name %}<div><strong>{{ q.reward_item_name }}</strong></div>{% endif %}
              {% if q.reward %}<div class="text-secondary">{{ q.reward }}</div>{% endif %}
            </td>
            <td>
              {% if is_owner %}
                <select class="form-select form-select-sm" name="status_{{ q.quest_id }}">
                  <option value="not_started" {% if st=='not_started' %}selected{% endif %}>Not Started</option>
                  <option value="in_progress" {% if st=='in_progress' %}selected{% endif %}>In Progress</option>
                  <option value="completed" {% if st=='completed' %}selected{% endif %}>Completed</option>
                </select>
              {% else %}
                {% if st=='completed' %}
                  <span class="badge bg-success">Completed</span>
                {% elif st=='in_progress' %}
                  <span class="badge bg-warning text-dark">In Progress</span>
                {% else %}
                  <span class="badge bg-secondary">Not Started</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_owner %}
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-success" type="submit">Save Quest Log</button>
        <a class="btn btn-secondary" href="{{ url_for('character_quests', character_id=character.character_id, view=view, type=qtype) }}">Reset</a>
      </div>
  </form>
    {% endif %}
</div>
{% endblock %}
